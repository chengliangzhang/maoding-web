<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="GetProjectCostMapper" >
  <resultMap id="BaseResultMapDto" type="com.maoding.projectcost.dto.ProjectCostDTO" >
    <id column="id" property="id" jdbcType="VARCHAR" />
    <result column="project_id" property="projectId" jdbcType="VARCHAR" />
    <result column="from_company_id" property="fromCompanyId" jdbcType="VARCHAR" />
    <result column="to_company_id" property="toCompanyId" jdbcType="VARCHAR" />
    <result column="type" property="type" jdbcType="VARCHAR" />
    <result column="fee" property="fee" jdbcType="DECIMAL" />
    <result column="remark" property="remark" jdbcType="VARCHAR" />
    <result column="create_date" property="createDate" jdbcType="TIMESTAMP" />
    <result column="create_by" property="createBy" jdbcType="VARCHAR" />
    <result column="update_date" property="updateDate" jdbcType="TIMESTAMP" />
    <result column="update_by" property="updateBy" jdbcType="VARCHAR" />
    <result column="status" property="status" jdbcType="VARCHAR" />
  </resultMap>

  <sql id="Base_Column_List" >
    id, project_id, from_company_id,to_company_id, type, fee,  remark, status,create_date,
    create_by, update_date, update_by
  </sql>

  <select id="selectByParam" parameterType="java.util.Map" resultMap="BaseResultMapDto">
    SELECT
    <include refid="Base_Column_List" />
    from maoding_web_project_cost
    where status= '0'
    and project_id=#{projectId,jdbcType=VARCHAR}
    <if test="type!=null">
      and type = #{type,jdbcType=VARCHAR}
    </if>
    <if test="fromCompanyId != null" >
     and from_company_id = #{fromCompanyId,jdbcType=VARCHAR}
    </if>
    <if test="toCompanyId != null" >
      and to_company_id = #{toCompanyId,jdbcType=VARCHAR}
    </if>
    <if test="flag != null" >
      and flag = #{flag,jdbcType=VARCHAR}
    </if>
    <if test="costId != null" >
      and id = #{costId,jdbcType=VARCHAR}
    </if>
    order by type,create_date
  </select>

  <!-- 获取组织内各项目的收付款汇总列表 -->
  <select id="listProjectCostSummary" resultType="com.maoding.projectcost.dto.ProjectCostSingleSummaryDTO" parameterType="com.maoding.projectcost.dto.ProjectCostSummaryQueryDTO">
      select <include refid="CommonMapper.countSQL"/>
          cost_type.fee as plan,
          <if test="isDetail == '1'.toString()">
              sum(if(cost_pay.paid_date is not null,ifnull(cost_pay.fee,0),0)) as `real`,
          </if>
          project_list.id
      from maoding_web_project project_list
          inner join maoding_web_project_cost cost_type on (cost_type.project_id = project_list.id
                  <choose>
                      <!-- 合同回款 -->
                      <when test="costType == 1">
                          and (cost_type.type = 1)
                          <if test="companyId != null">
                              and (cost_type.to_company_id = #{companyId})
                          </if>
                      </when>
                      <!-- 技术审查费 -->
                      <when test="costType == 2">
                          and (cost_type.type = 2)
                          <if test="companyId != null">
                            and (cost_type.to_company_id = #{companyId})
                          </if>
                      </when>
                      <!-- 合作设计费收款 -->
                      <when test="costType == 10">
                          and (cost_type.type = 3)
                          <if test="companyId != null">
                            and (cost_type.to_company_id = #{companyId})
                          </if>
                      </when>
                      <!-- 合作设计费付款 -->
                      <when test="costType == 11">
                          and (cost_type.type = 3)
                          <if test="companyId != null">
                              and (cost_type.from_company_id = #{companyId})
                          </if>
                      </when>
                      <otherwise>
                          <if test="companyId != null">
                              and ((cost_type.from_company_id = #{companyId}) or (cost_type.to_company_id = #{companyId}))
                          </if>
                      </otherwise>
                  </choose>
              )
          <if test="isDetail == '1'.toString()">
              inner join maoding_web_project_cost_point cost_point on (cost_point.cost_id = cost_type.id)
              inner join maoding_web_project_cost_point_detail cost_detail on (cost_detail.point_id = cost_point.id)
              inner join maoding_web_project_cost_payment_detail cost_pay on (cost_pay.point_detail_id = cost_detail.id)
          </if>
      where (project_list.pstatus = '0')
          <!-- 项目立项时间过滤条件 -->
          <if test="endDate != null">
              and (addDate(#{endDate,jdbcType=TIMESTAMP},1) > ifnull(project_list.project_create_date,project_list.create_date))
          </if>
          <if test="startDate != null">
              and (ifnull(project_list.project_create_date,project_list.create_date) >= #{startDate,jdbcType=TIMESTAMP})
          </if>
      group by project_list.id
      <include refid="CommonMapper.limitSQL"/>
  </select>

  <select id="listProjectExpSummary" resultType="com.maoding.projectcost.dto.ProjectExpSingleSummaryDTO" parameterType="com.maoding.projectcost.dto.ProjectCostSummaryQueryDTO">
      select <include refid="CommonMapper.countSQL"/>
          sum(if(exp_main.type=1,ifnull(exp_detail.exp_amount,0),0)) as expense,
          sum(if(exp_main.type=2,ifnull(exp_detail.exp_amount,0),0)) as cost,
          project_list.id
      from maoding_web_project project_list
          inner join maoding_web_exp_detail exp_detail on (
              exp_detail.project_id = project_list.id
          )
          inner join maoding_web_exp_main exp_main on (
              <!-- 仅统计财务已拨款 -->
              exp_main.approve_status = 6
              <!-- 仅统计报销和费用申请 -->
              and exp_main.type in (1,2)
              and exp_main.id = exp_detail.main_id
              <if test="companyId != null">
                  and exp_main.company_id = #{companyId}
              </if>
          )
      where (project_list.pstatus = '0')
          <!-- 项目立项时间过滤条件 -->
          <if test="endDate != null">
              and (addDate(#{endDate,jdbcType=TIMESTAMP},1) > ifnull(project_list.project_create_date,project_list.create_date))
          </if>
          <if test="startDate != null">
              and (ifnull(project_list.project_create_date,project_list.create_date) >= #{startDate,jdbcType=TIMESTAMP})
          </if>
      group by project_list.id
      <include refid="CommonMapper.limitSQL"/>
  </select>
</mapper>